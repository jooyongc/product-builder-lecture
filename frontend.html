<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE K-EDIT | Curated Korea Tour</title>
    <!-- 
      [THE K-EDIT Frontend v3.6 - Journal List Modal & Hero Fix]
      - Version: 3.6
      - Date: 2026.01.25
      - Author: Gemini Helper
      
      [Change Log]
      v3.6:
        1. [Fix] Hero Image Tiling:
           - .hero-bg 클래스에 'background-repeat: no-repeat' 추가하여 이미지 반복 현상 해결.
        2. [UX] Journal List Modal:
           - 'View All Stories' 클릭 시 전체 글 목록 모달 팝업 구현.
           - 목록 -> 상세글 이동 시 'Back to List' 네비게이션 기능 추가 (Nested Modal UX).
      v3.5: Style Isolation (#k-frontend-scope).
    -->
    
    <!-- 1. Libraries & Fonts -->
    <link rel="stylesheet" href="tailwind.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
    
    <link rel="stylesheet" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* Scoped CSS Reset */
        #k-frontend-scope {
            font-family: 'Montserrat', sans-serif;
            background-color: white;
            color: #111;
            line-height: 1.5;
            font-size: 16px;
            text-align: left; 
            box-sizing: border-box;
        }
        #k-frontend-scope *, #k-frontend-scope *::before, #k-frontend-scope *::after {
            box-sizing: border-box;
            border-width: 0;
            border-style: solid;
            border-color: #e5e7eb;
        }
        #k-frontend-scope a { text-decoration: none; color: inherit; transition: all 0.2s; box-shadow: none; }
        #k-frontend-scope button { background: none; border: none; padding: 0; cursor: pointer; color: inherit; box-shadow: none; }
        #k-frontend-scope h1, #k-frontend-scope h2, #k-frontend-scope h3 { margin: 0; font-weight: inherit; line-height: inherit; color: inherit; }
        #k-frontend-scope p { margin: 0; margin-bottom: 1rem; }
        #k-frontend-scope ul, #k-frontend-scope li { list-style: none; margin: 0; padding: 0; }
        #k-frontend-scope img { max-width: 100%; display: block; height: auto; }

        /* Utilities */
        .img-fill { position: absolute !important; inset: 0 !important; width: 100% !important; height: 100% !important; object-fit: cover !important; display: block !important; margin: 0 !important; }
        .fade-in { animation: fadeIn 0.8s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .active-tab { border-bottom: 2px solid #000 !important; color: #000 !important; font-weight: 700 !important; }

        /* Hero Background Fix [v3.6] */
        .hero-bg { 
            background-color: #f3f4f6; 
            background-size: cover; 
            background-position: center; 
            background-repeat: no-repeat; /* [Fix] Prevent Tiling */
            position: relative; 
            transition: background-image 0.5s ease-in-out; 
        }
        .hero-bg::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.1); z-index: 0; transition: background 0.5s ease; }
        .hero-content { position: relative; z-index: 1; transition: color 0.5s ease; }

        /* Theme Styles */
        #hero-section[data-theme="dark"] .hero-bg::before { background: rgba(0, 0, 0, 0.4); }
        #hero-section[data-theme="dark"] #hero-label { color: #fff; border-color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.5); }
        #hero-section[data-theme="dark"] #hero-title { color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        #hero-section[data-theme="dark"] #hero-subtitle { color: #f3f4f6; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        #hero-section[data-theme="light"] .hero-bg::before { background: rgba(255, 255, 255, 0.3); }
        #hero-section[data-theme="light"] #hero-label { color: #111; border-color: #111; }
        #hero-section[data-theme="light"] #hero-title { color: #111; }
        #hero-section[data-theme="light"] #hero-subtitle { color: #374151; }

        /* Modal */
        body.modal-open { overflow: hidden; padding-right: 6px; } 
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); z-index: 10000; backdrop-filter: blur(4px); display: none; opacity: 0; transition: opacity 0.3s ease; }
        .modal-overlay.open { display: flex; opacity: 1; }
        .modal-content { background: white; width: 95%; max-width: 900px; max-height: 90vh; overflow-y: auto; border-radius: 12px; position: relative; opacity: 0; transform: translateY(20px); transition: all 0.3s ease; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .modal-overlay.open .modal-content { opacity: 1; transform: translateY(0); }
        .modal-close-btn { position: sticky; top: 0; right: 0; float: right; padding: 1rem; z-index: 50; cursor: pointer; color: #666; transition: color 0.2s; background: rgba(255,255,255,0.8); backdrop-filter: blur(4px); border-bottom-left-radius: 12px; }
        .modal-close-btn:hover { color: black; }
        
        /* Chatbot */
        #chat-widget { transition: all 0.3s ease-in-out; z-index: 9990; }
        .chat-message { max-width: 80%; padding: 10px 14px; border-radius: 12px; font-size: 0.9rem; line-height: 1.5; margin-bottom: 10px; }
        .chat-user { background-color: #111; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-bot { background-color: #f3f4f6; color: #1f2937; align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid #e5e7eb; }
        .typing-dot { width: 6px; height: 6px; background: #9ca3af; border-radius: 50%; animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* Journal Body */
        #journal-body img { max-width: 100%; height: auto; border-radius: 8px; margin: 1rem 0; }
        #journal-body h2 { font-family: 'Playfair Display', serif; font-size: 1.8rem; margin-top: 2rem; margin-bottom: 1rem; }
        #journal-body p { margin-bottom: 1rem; line-height: 1.8; color: #374151; }

        /* WP Admin Bar Fix */
        body.admin-bar #navbar { top: 32px !important; }
        @media screen and (max-width: 782px) { body.admin-bar #navbar { top: 46px !important; } }
    </style>
</head>
<body class="antialiased selection:bg-black selection:text-white">

    <div id="k-frontend-scope" class="w-full relative">

        <!-- Navbar -->
        <nav class="fixed top-0 left-0 right-0 bg-white/95 backdrop-blur-sm z-[9999] border-b border-gray-100 shadow-sm transition-all" id="navbar">
            <div class="max-w-7xl mx-auto px-6 lg:px-8">
                <div class="flex items-center justify-between h-20 w-full">
                    <div class="flex-1 flex justify-start items-center">
                        <div class="cursor-pointer" onclick="window.scrollTo(0,0)">
                            <span class="font-montserrat font-extrabold tracking-[0.15em] border-2 border-black px-3 py-1 text-xl md:text-2xl whitespace-nowrap leading-none block">THE K-EDIT</span>
                        </div>
                    </div>
                    <div class="hidden md:flex flex-auto justify-center items-center space-x-12 text-sm font-medium text-gray-500 uppercase tracking-widest">
                        <a href="#destinations" class="hover:text-black transition">Editions</a>
                        <a href="#journal" class="hover:text-black transition">Journal</a>
                        <a href="#pricing" class="hover:text-black transition">Pricing</a>
                    </div>
                    <div class="flex-1 flex justify-end items-center">
                        <a href="https://wa.me/821039134667" target="_blank" class="bg-black text-white px-6 py-2 rounded-sm text-sm font-bold hover:bg-gray-800 transition flex items-center gap-2 whitespace-nowrap shadow-md no-underline">
                            <i class="fab fa-whatsapp"></i> Inquiry
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Hero Section -->
        <header id="hero-section" class="relative pt-32 pb-24 lg:pt-48 lg:pb-32 bg-gray-50 hero-bg w-full" data-theme="light">
            <div class="max-w-7xl mx-auto px-6 lg:px-8 text-center fade-in hero-content">
                <div id="hero-label" class="inline-block px-4 py-1 mb-6 text-xs font-bold tracking-[0.2em] uppercase border-b-2 transition-colors duration-500">The Signature Collection</div>
                <h1 id="hero-title" class="text-5xl sm:text-6xl lg:text-7xl font-bold mb-8 serif leading-tight transition-colors duration-500">We Edit Korea<br>For You.</h1>
                <p id="hero-subtitle" class="max-w-3xl mx-auto text-xl font-medium mb-10 whitespace-pre-line drop-shadow-sm transition-colors duration-500">Not a tour guide, but a Curator.</p>
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <a href="#destinations" class="px-8 py-4 bg-black text-white text-lg font-medium rounded-sm shadow-xl hover:bg-gray-800 transition border border-transparent no-underline">View The Edits</a>
                </div>
            </div>
        </header>

        <!-- Editions -->
        <section id="destinations" class="py-24 bg-white w-full">
            <div class="max-w-7xl mx-auto px-6 lg:px-8">
                <div class="text-center mb-16">
                    <h2 class="text-4xl font-bold mb-4 serif">The 2026 Edits</h2>
                    <p class="text-gray-500">Choose your curated journey.</p>
                </div>
                <div class="flex flex-wrap justify-center mb-12 border-b border-gray-200 gap-4 md:gap-0">
                    <button onclick="switchTab('trend')" class="px-6 py-4 text-black font-bold border-b-2 border-black uppercase tracking-widest transition active-tab" id="btn-trend">1. Trend Edit</button>
                    <button onclick="switchTab('gourmet')" class="px-6 py-4 text-gray-400 hover:text-black font-medium uppercase tracking-widest transition" id="btn-gourmet">2. Gourmet Edit</button>
                    <button onclick="switchTab('heritage')" class="px-6 py-4 text-gray-400 hover:text-black font-medium uppercase tracking-widest transition" id="btn-heritage">3. Heritage Edit</button>
                    <button onclick="switchTab('school')" class="px-6 py-4 text-blue-600 hover:text-blue-800 font-bold uppercase tracking-widest transition" id="btn-school">4. Future Edit</button>
                </div>
                <div class="min-h-[600px]">
                    <div id="trend" class="tab-content fade-in block">
                        <div class="flex flex-col lg:flex-row gap-12"><div class="lg:w-1/2 space-y-4"><div class="skeleton h-8 w-1/3"></div><div class="skeleton h-64 w-full"></div></div><div class="lg:w-1/2 grid grid-cols-2 gap-4"><div class="skeleton h-80 w-full"></div><div class="skeleton h-80 w-full"></div></div></div>
                    </div>
                    <div id="gourmet" class="tab-content fade-in hidden"></div>
                    <div id="heritage" class="tab-content fade-in hidden"></div>
                    <div id="school" class="tab-content fade-in hidden"></div>
                </div>
            </div>
        </section>

        <!-- Journal -->
        <section id="journal" class="py-24 bg-gray-50 border-t border-gray-200 w-full">
            <div class="max-w-7xl mx-auto px-6 lg:px-8">
                <div class="flex justify-between items-end mb-12">
                    <div><span class="text-gray-500 uppercase tracking-widest text-xs font-bold">From our Blog</span><h2 class="text-4xl font-bold mt-2 serif">The K-Journal</h2></div>
                    <!-- [v3.6] Updated Link to Open List Modal -->
                    <a href="#" onclick="openJournalListModal(); return false;" class="hidden md:block text-black border-b border-black pb-1 hover:text-gray-600 transition">View All Stories</a>
                </div>
                <div id="journal-grid" class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="space-y-4"><div class="skeleton h-64 w-full"></div><div class="skeleton h-6 w-3/4"></div></div>
                    <div class="space-y-4"><div class="skeleton h-64 w-full"></div><div class="skeleton h-6 w-3/4"></div></div>
                    <div class="space-y-4"><div class="skeleton h-64 w-full"></div><div class="skeleton h-6 w-3/4"></div></div>
                </div>
            </div>
        </section>

        <!-- Instagram -->
        <section class="py-20 bg-white w-full">
            <div class="max-w-7xl mx-auto px-6 lg:px-8">
                <div class="text-center mb-12">
                    <a href="https://instagram.com/the_k_edit" target="_blank" id="insta-link" class="inline-block group cursor-pointer no-underline">
                        <i class="fab fa-instagram text-3xl mb-4 text-gray-400 group-hover:text-black transition"></i>
                        <h2 class="text-2xl font-bold serif group-hover:underline" id="insta-handle">@the_k_edit</h2>
                    </a>
                    <p class="text-gray-500 text-sm mt-2">Follow our journey for daily inspiration.</p>
                </div>
                <div id="insta-grid" class="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-4"></div>
            </div>
        </section>

        <!-- Pricing -->
        <section id="pricing" class="py-24 bg-gray-900 text-white w-full">
            <div class="max-w-7xl mx-auto px-6 lg:px-8">
                <h2 class="text-4xl font-bold mb-12 serif text-white text-center">Package Pricing</h2>
                <div id="pricing-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                    <div class="text-center text-gray-500 col-span-4">Loading pricing...</div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="bg-black py-12 border-t border-gray-800 w-full">
            <div class="max-w-7xl mx-auto px-6 text-center">
                <h2 class="inline-block border-2 border-white px-3 py-1 text-white font-montserrat font-bold tracking-widest mb-6">THE K-EDIT</h2>
                <p id="footer-text" class="text-gray-500 mb-8 text-sm leading-relaxed">Curated by Local Live Lab. <br>Managed by Korea by Local Inc.</p>
                <div class="flex justify-center gap-4 text-white text-2xl mb-8">
                    <a href="#" class="hover:text-pink-500 transition"><i class="fab fa-instagram"></i></a>
                    <a href="#" class="hover:text-blue-500 transition"><i class="fab fa-facebook"></i></a>
                    <a href="#" class="hover:text-green-500 transition"><i class="fab fa-whatsapp"></i></a>
                </div>
                <p id="footer-copy" class="text-gray-700 text-xs">\u00a9 2026 THE K-EDIT. All Rights Reserved.</p>
            </div>
        </footer>

        <!-- [MODAL 1] Journal Detail Viewer -->
        <div id="journal-modal" class="modal-overlay items-center justify-center p-4">
            <div class="modal-content">
                <div class="sticky top-0 right-0 z-50 flex justify-between items-center bg-white/90 backdrop-blur border-b border-gray-100 p-4 rounded-t-xl">
                    <!-- [v3.6] Back Button (Hidden by default) -->
                    <button id="journal-back-btn" onclick="backToJournalList()" class="hidden text-sm font-bold text-gray-500 hover:text-black flex items-center gap-2">
                        <i class="fas fa-arrow-left"></i> Back to List
                    </button>
                    <!-- Close Button -->
                    <button onclick="closeModal('journal-modal')" class="text-gray-400 hover:text-black ml-auto"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div id="journal-modal-body" class="p-8 lg:p-12"></div>
            </div>
        </div>

        <!-- [MODAL 2] Itinerary Viewer -->
        <div id="itinerary-modal" class="modal-overlay items-center justify-center p-4">
            <div class="modal-content bg-slate-50">
                <button onclick="closeModal('itinerary-modal')" class="modal-close-btn"><i class="fas fa-times text-xl"></i></button>
                <div id="itinerary-modal-body" class="p-6 lg:p-10"></div>
            </div>
        </div>

        <!-- [MODAL 3] Journal List Modal [v3.6] -->
        <div id="journal-list-modal" class="modal-overlay items-center justify-center p-4">
            <div class="modal-content bg-gray-50 h-[90vh]">
                <div class="sticky top-0 bg-white z-10 border-b border-gray-100 p-6 flex justify-between items-center">
                    <div>
                        <h3 class="font-serif text-2xl font-bold">The K-Journal</h3>
                        <p class="text-xs text-gray-500 mt-1">All Stories</p>
                    </div>
                    <button onclick="closeModal('journal-list-modal')" class="text-gray-400 hover:text-black"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div id="journal-list-grid" class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="text-center w-full col-span-3 py-20">Loading...</div>
                </div>
            </div>
        </div>

        <!-- [CHATBOT] -->
        <div class="fixed bottom-6 right-6 z-[9995] flex flex-col items-end gap-4">
            <div id="chat-window" class="hidden bg-white w-[360px] h-[550px] max-h-[80vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden border border-gray-100 transition-all origin-bottom-right transform scale-90 opacity-0">
                <div class="bg-black text-white p-4 flex justify-between items-center"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-black font-bold font-serif text-sm">K</div><div><h4 class="font-bold text-sm">THE K-EDIT Curator</h4><p class="text-[10px] text-gray-300 flex items-center gap-1"><span class="w-1.5 h-1.5 bg-green-400 rounded-full"></span> Online</p></div></div><button onclick="toggleChat()" class="text-gray-300 hover:text-white"><i class="fas fa-times"></i></button></div>
                <div id="chat-messages" class="flex-1 p-4 overflow-y-auto bg-gray-50 flex flex-col gap-3"><div class="chat-bot chat-message">Hello! I'm your personal AI curator.<br><span class="text-xs text-gray-500">How can I assist your journey?</span></div></div>
                <div class="px-4 py-2 bg-gray-50 flex gap-2 overflow-x-auto text-xs no-scrollbar"><button onclick="sendPreset('Tell me about Trend Edit')" class="whitespace-nowrap px-3 py-1 bg-white border border-gray-200 rounded-full hover:bg-gray-100 text-gray-600 transition">Trend Edit?</button><button onclick="sendPreset('Pricing for Gourmet Tour')" class="whitespace-nowrap px-3 py-1 bg-white border border-gray-200 rounded-full hover:bg-gray-100 text-gray-600 transition">Pricing?</button><button onclick="sendPreset('Connect me to WhatsApp')" class="whitespace-nowrap px-3 py-1 bg-blue-50 border border-blue-100 rounded-full hover:bg-blue-100 text-blue-600 transition">Contact Human</button></div>
                <div class="p-3 bg-white border-t border-gray-100 flex gap-2"><input type="text" id="chat-input" placeholder="Type..." class="flex-1 bg-gray-100 border-none rounded-full px-4 py-2 text-sm focus:ring-1 focus:ring-black outline-none" onkeypress="if(event.key === 'Enter') sendMessage()"><button onclick="sendMessage()" class="w-10 h-10 rounded-full bg-black text-white flex items-center justify-center hover:bg-gray-800 transition"><i class="fas fa-paper-plane text-xs"></i></button></div>
            </div>
            <button onclick="toggleChat()" id="chat-btn" class="w-14 h-14 bg-black text-white rounded-full shadow-lg flex items-center justify-center hover:bg-gray-800 transition hover:scale-105 group relative"><i class="fas fa-comment-dots text-2xl group-hover:scale-110 transition"></i><span class="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></span></button>
        </div>

    </div>

    <!-- Script -->
    <script>
        const firebaseConfig = { apiKey: "AIzaSyBGRa_szSMowlwQwCxPLZsOcmV0qNbJ7-Y", authDomain: "thek-edit.firebaseapp.com", projectId: "thek-edit", storageBucket: "thek-edit.firebasestorage.app", messagingSenderId: "117759852953", appId: "1:117759852953:web:75096220a1441126d69308" };
        const geminiApiKey = (window.KEDIT_GEMINI_KEY || '').trim();
        
        let db; let siteContext = { editions: {}, posts: [] }; let cachedPosts = {}; let allPostsLoaded = false;

        function escapeHTML(str) { return String(str || '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s])); }
        function sanitizeHTML(html) {
            if (typeof DOMPurify === 'undefined') return html;
            return DOMPurify.sanitize(html, { ALLOWED_TAGS: ['h1','h2','h3','p','ul','ol','li','strong','em','b','i','a','img','blockquote','br'], ALLOWED_ATTR: ['href','src','alt','title','style','target','rel'] });
        }
        function stripHTML(html) {
            if (typeof DOMPurify !== 'undefined') return DOMPurify.sanitize(html, { ALLOWED_TAGS: [], ALLOWED_ATTR: [] });
            const div = document.createElement('div');
            div.innerHTML = html;
            return div.textContent || '';
        }
        function safeUrl(url, fallback) {
            const u = String(url || '').trim();
            if (/^https?:\/\//i.test(u)) return u;
            return fallback || '';
        }
        function sanitizeHandle(handle) {
            return String(handle || '').replace(/[^a-zA-Z0-9._]/g, '');
        }

        window.addEventListener('load', () => {
            if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            firebase.auth().signInAnonymously().then(() => { initApp(); initChatContext(); }).catch(e => console.error("Auth Error", e));
        });

        function initApp() { loadConfig(); loadEditions(); loadInstagram(); loadWPPosts(); }

        // --- Modals ---
        function openModal(id) {
            const el = document.getElementById(id);
            if(el) { el.classList.add('open'); document.body.classList.add('modal-open'); const c = el.querySelector('.modal-content'); if(c) c.scrollTop = 0; }
        }
        function closeModal(id) {
            const el = document.getElementById(id);
            if(el) { el.classList.remove('open'); document.body.classList.remove('modal-open'); }
        }

        // [v3.6] Journal Logic Updates
        function openJournalModal(postId, fromList = false) {
            const post = cachedPosts[postId];
            if (!post) return;
            
            // Handle List Navigation
            if(fromList) {
                document.getElementById('journal-list-modal').classList.remove('open'); // Hide List, keep body class
                document.getElementById('journal-back-btn').classList.remove('hidden');
                document.getElementById('journal-back-btn').setAttribute('onclick', 'backToJournalList()');
            } else {
                document.getElementById('journal-back-btn').classList.add('hidden');
            }

            const body = document.getElementById('journal-modal-body');
            let html = `
                <div class="max-w-3xl mx-auto">
                    <span class="text-blue-600 font-bold uppercase tracking-widest text-xs mb-4 block">${escapeHTML(post.category)}</span>
                    <h1 class="text-3xl md:text-5xl font-bold mb-6 serif leading-tight">${escapeHTML(post.title.rendered)}</h1>
                    <div class="flex items-center text-gray-500 text-sm mb-8 border-b border-gray-100 pb-8">
                        <span class="mr-4">${escapeHTML(new Date(post.date).toLocaleDateString())}</span>
                        <span>by The K-Edit</span>
                    </div>
                    <div id="journal-body" class="prose prose-lg max-w-none">${sanitizeHTML(post.content.rendered)}</div>
                </div>
            `;
            body.innerHTML = html;
            openModal('journal-modal');
        }

        function backToJournalList() {
            closeModal('journal-modal');
            // Re-open list modal (without body scroll unlock)
            const listModal = document.getElementById('journal-list-modal');
            listModal.classList.add('open');
            document.body.classList.add('modal-open');
        }

        async function openJournalListModal() {
            openModal('journal-list-modal');
            if(!allPostsLoaded) {
                const configDoc = await db.collection('k_site_config').doc('settings').get();
                if(configDoc.exists && configDoc.data().wp_url) {
                    const wpUrl = configDoc.data().wp_url.replace(/\/$/, "");
                    try {
                        // Fetch more posts for list view
                        const res = await fetch(`${wpUrl}/wp-json/wp/v2/posts?per_page=12&_embed`, { credentials: 'omit' });
                        const posts = await res.json();
                        const grid = document.getElementById('journal-list-grid');
                        grid.innerHTML = posts.map(post => {
                            cachedPosts[post.id] = post; // Cache
                            // Extract Category
                            const category = post._embedded && post._embedded['wp:term'] && post._embedded['wp:term'][0].length > 0 ? post._embedded['wp:term'][0][0].name : 'Journal';
                            cachedPosts[post.id].category = category;
                            // Extract Image
                            let imgUrl = 'https://placehold.co/600x400?text=No+Image';
                            if(post._embedded && post._embedded['wp:featuredmedia'] && post._embedded['wp:featuredmedia'][0]) {
                                const media = post._embedded['wp:featuredmedia'][0];
                                imgUrl = media.media_details?.sizes?.medium_large?.source_url || media.source_url;
                            }
                            const date = new Date(post.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });

                            return `
                                <article class="group cursor-pointer flex flex-col bg-white rounded-lg border border-gray-100 overflow-hidden shadow-sm hover:shadow-md transition" onclick="openJournalModal(${post.id}, true)">
                                    <div class="h-48 bg-gray-100 relative w-full overflow-hidden">
                                        <img src="${escapeHTML(safeUrl(imgUrl, 'https://placehold.co/600x400?text=No+Image'))}" class="img-fill transition duration-500 group-hover:scale-105" alt="${escapeHTML(post.title.rendered)}">
                                        <div class="absolute top-2 left-2 bg-white/90 backdrop-blur px-2 py-1 text-[10px] font-bold text-black uppercase rounded-sm">${escapeHTML(category)}</div>
                                    </div>
                                    <div class="p-4 flex-1 flex flex-col">
                                        <h4 class="font-bold text-lg mb-2 serif leading-tight line-clamp-2">${escapeHTML(post.title.rendered)}</h4>
                                        <p class="text-xs text-gray-400 mt-auto">${escapeHTML(date)}</p>
                                    </div>
                                </article>
                            `;
                        }).join('');
                        allPostsLoaded = true;
                    } catch(e) { document.getElementById('journal-list-grid').innerHTML = '<div class="col-span-3 text-center text-red-400">Failed to load posts.</div>'; }
                }
            }
        }

        // --- Itinerary Logic ---
        function openItineraryModal(editionId) {
            const data = siteContext.editions[editionId];
            if (!data) return;
            
            const body = document.getElementById('itinerary-modal-body');
            let itinHtml = '';
            
            if (data.itinerary && data.itinerary.length > 0) {
                itinHtml = data.itinerary.map((item, idx) => `
                    <div class="flex gap-6 mb-12 relative last:mb-0">
                        ${idx !== data.itinerary.length - 1 ? '<div class="absolute left-[26px] top-12 bottom-[-48px] w-[2px] bg-gray-200"></div>' : ''}
                        <div class="flex-shrink-0">
                            <div class="w-14 h-14 bg-black text-white rounded-full flex items-center justify-center font-bold text-sm shadow-lg z-10 relative">
                                ${escapeHTML(item.day).replace(/[^0-9]/g, '') || (idx+1)}
                            </div>
                        </div>
                        <div class="flex-1 bg-white p-6 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition">
                            <span class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1 block">${escapeHTML(item.day)}</span>
                            <h3 class="text-xl font-bold mb-2 serif">${escapeHTML(item.title)}</h3>
                            <div class="flex flex-wrap gap-4 text-sm text-gray-600 mb-4">
                                ${item.loc ? `<span class="flex items-center"><i class="fas fa-map-marker-alt mr-2 text-blue-500"></i> ${escapeHTML(item.loc)}</span>` : ''}
                                ${item.stay ? `<span class="flex items-center"><i class="fas fa-bed mr-2 text-blue-500"></i> ${escapeHTML(item.stay)}</span>` : ''}
                            </div>
                            ${item.desc ? `<p class="text-gray-600 leading-relaxed mb-4 text-sm">${escapeHTML(item.desc)}</p>` : ''}
                            ${item.img ? `<div class="aspect-video w-full bg-gray-100 rounded-lg overflow-hidden relative"><img src="${escapeHTML(safeUrl(item.img))}" class="img-fill" alt="${escapeHTML(item.title)}"></div>` : ''}
                        </div>
                    </div>
                `).join('');
            } else {
                itinHtml = `<div class="text-center py-20 text-gray-400"><i class="fas fa-calendar-times text-4xl mb-4"></i><p>Detailed itinerary is being curated.</p></div>`;
            }

            body.innerHTML = `
                <div class="text-center mb-10">
                    <span class="text-blue-600 font-bold uppercase text-xs tracking-widest">Day by Day</span>
                    <h2 class="text-3xl font-bold serif mt-2">${escapeHTML(data.title || '')}</h2>
                    <p class="text-gray-500 mt-2">Curated Itinerary</p>
                </div>
                <div class="max-w-2xl mx-auto">${itinHtml}</div>
                <div class="text-center mt-12 pt-8 border-t border-gray-200">
                    <a href="https://wa.me/821039134667?text=Inquiry:${encodeURIComponent(editionId)}" target="_blank" class="inline-flex items-center justify-center px-8 py-4 bg-green-600 hover:bg-green-700 text-white font-bold rounded-full shadow-lg transition transform hover:scale-105 no-underline">
                        <i class="fab fa-whatsapp mr-2 text-xl"></i> Contact to Book This Tour
                    </a>
                </div>
            `;
            openModal('itinerary-modal');
        }

        function loadConfig() {
            db.collection('k_site_config').doc('hero').onSnapshot(doc => {
                if(doc.exists) {
                    const d = doc.data();
                    if(d.label) document.getElementById('hero-label').innerText = d.label;
                    if(d.title) document.getElementById('hero-title').innerHTML = sanitizeHTML(d.title);
                    if(d.subtitle) document.getElementById('hero-subtitle').innerText = d.subtitle;
                    if(d.bgImage) {
                        const heroSec = document.getElementById('hero-section'); 
                        const safeBg = safeUrl(d.bgImage);
                        if (safeBg) heroSec.style.backgroundImage = `url('${safeBg}')`;
                        const img = new Image(); img.crossOrigin = "Anonymous"; img.src = safeBg;
                        img.onload = function() {
                            try { const c = document.createElement('canvas'); c.width=50; c.height=50; const ctx=c.getContext('2d'); ctx.drawImage(this,0,0,50,50); const d = ctx.getImageData(0,0,50,50).data; let s=0; for(let i=0;i<d.length;i+=4) s+=(d[i]+d[i+1]+d[i+2])/3; heroSec.setAttribute('data-theme', (s/(2500)) < 128 ? 'dark' : 'light'); } catch(e) { heroSec.setAttribute('data-theme', 'light'); }
                        };
                    }
                }
            });
            db.collection('k_site_config').doc('footer').onSnapshot(doc => { if(doc.exists) { const d = doc.data(); if(d.text) document.getElementById('footer-text').innerHTML = sanitizeHTML(d.text.replace(/\n/g, '<br>')); if(d.copyright) document.getElementById('footer-copy').innerText = d.copyright; } });
        }

        function loadEditions() {
            const ids = ['trend', 'gourmet', 'heritage', 'school'];
            db.collection('k_editions').onSnapshot(snapshot => {
                const dataMap = {}; snapshot.forEach(doc => dataMap[doc.id] = doc.data());
                siteContext.editions = dataMap; 
                ids.forEach(id => {
                    const d = dataMap[id]; const container = document.getElementById(id);
                    if(container && d) {
                        const pointsHtml = (d.points || []).map(p => `<li class="flex items-center"><span class="mr-3 text-blue-500">\u2713</span> ${escapeHTML(p)}</li>`).join('');
                        container.innerHTML = `<div class="flex flex-col lg:flex-row gap-12 items-center"><div class="lg:w-1/2"><span class="text-blue-600 font-bold tracking-widest text-xs uppercase mb-2 block">${escapeHTML(d.subtitle || 'Signature Tour')}</span><h3 class="text-4xl font-bold mb-6 serif">${escapeHTML(d.title || 'Loading...')}</h3><p class="text-gray-600 mb-6 text-lg leading-relaxed whitespace-pre-line">${escapeHTML(d.desc || '')}</p><ul class="space-y-4 mb-8 text-gray-700">${pointsHtml}</ul><button onclick="openItineraryModal('${id}')" class="inline-flex items-center justify-center px-8 py-3 border border-black text-base font-medium rounded-sm text-black bg-white hover:bg-black hover:text-white md:text-lg transition"><i class="fas fa-list-ul mr-2"></i> View Itinerary (\uc0c1\uc138 \uc77c\uc815)</button></div><div class="lg:w-1/2 grid grid-cols-2 gap-4"><div class="bg-gray-100 h-80 rounded-lg overflow-hidden relative group w-full"><img src="${escapeHTML(safeUrl(d.img1 || 'https://placehold.co/400'))}" class="img-fill transition duration-700 group-hover:scale-105" alt="${escapeHTML(d.title || 'Edit')} 1"></div><div class="bg-gray-200 h-80 rounded-lg overflow-hidden relative group w-full"><img src="${escapeHTML(safeUrl(d.img2 || 'https://placehold.co/400'))}" class="img-fill transition duration-700 group-hover:scale-105" alt="${escapeHTML(d.title || 'Edit')} 2"></div></div></div>`;
                    }
                });
                const pricingGrid = document.getElementById('pricing-grid');
                pricingGrid.innerHTML = ids.map(id => {
                    const d = dataMap[id] || {};
                    let cardClass = "bg-gray-800 border-gray-700"; let textClass = "text-blue-400";
                    if(id === 'school') { cardClass = "bg-white text-gray-900 border-blue-600 transform lg:-translate-y-4 shadow-2xl relative"; textClass = "text-blue-900"; }
                    else if(id === 'gourmet') textClass = "text-orange-400"; else if(id === 'heritage') textClass = "text-stone-400";
                    return `<div class="${cardClass} p-8 rounded-lg border hover:border-gray-500 transition flex flex-col h-full">${id === 'school' ? '<div class="absolute top-0 right-0 bg-blue-600 text-white text-xs font-bold px-3 py-1 uppercase">For Schools</div>' : ''}<h4 class="text-xl font-bold ${textClass} mb-2">${escapeHTML(d.title ? d.title.split(':')[0] : 'Edit')}</h4><p class="text-sm ${id==='school'?'text-gray-500':'text-gray-400'} mb-4">${escapeHTML(d.subtitle || '')}</p><div class="mb-6"><span class="text-3xl font-light">$${escapeHTML(d.price || '0')}</span><span class="text-sm opacity-50">/ pp</span></div><a href="https://wa.me/821039134667?text=Book:${encodeURIComponent(id)}" target="_blank" class="mt-auto block text-center bg-green-600 hover:bg-green-700 text-white py-2 rounded font-bold text-sm transition no-underline"><i class="fab fa-whatsapp"></i> Book Now</a></div>`;
                }).join('');
            });
        }

        async function loadWPPosts() {
            let wpUrl = ''; const configDoc = await db.collection('k_site_config').doc('settings').get();
            if(configDoc.exists && configDoc.data().wp_url) { wpUrl = configDoc.data().wp_url; } 
            else { renderMockJournal(); return; }
            wpUrl = wpUrl.replace(/\/$/, "");
            
            fetch(`${wpUrl}/wp-json/wp/v2/posts?per_page=3&_embed`, { credentials: 'omit' }).then(res => { if(!res.ok) throw new Error(); return res.json(); }).then(posts => {
                const grid = document.getElementById('journal-grid'); if(posts.length === 0) { renderMockJournal(); return; }
                
                grid.innerHTML = posts.map(post => {
                    cachedPosts[post.id] = post;
                    const category = post._embedded && post._embedded['wp:term'] && post._embedded['wp:term'][0].length > 0 ? post._embedded['wp:term'][0][0].name : 'Journal';
                    cachedPosts[post.id].category = category;

                    let imgUrl = 'https://placehold.co/600x400?text=No+Image';
                    if(post._embedded && post._embedded['wp:featuredmedia'] && post._embedded['wp:featuredmedia'][0]) {
                        const media = post._embedded['wp:featuredmedia'][0];
                        imgUrl = media.media_details?.sizes?.medium_large?.source_url || media.source_url;
                    }
                    const date = new Date(post.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                    
                    return `<article class="group cursor-pointer flex flex-col h-full" onclick="openJournalModal(${post.id})"><div class="overflow-hidden rounded-lg mb-4 h-64 bg-gray-100 border border-gray-100 relative w-full"><img src="${escapeHTML(safeUrl(imgUrl, 'https://placehold.co/600x400?text=No+Image'))}" class="img-fill transition duration-500 group-hover:scale-105" alt="${escapeHTML(post.title.rendered)}"><div class="absolute top-4 left-4 bg-white/90 backdrop-blur px-3 py-1 text-xs font-bold text-black uppercase tracking-wider rounded-sm shadow-sm">${escapeHTML(category)}</div></div><h3 class="text-xl font-bold mt-2 mb-2 group-hover:text-blue-700 transition leading-snug font-serif">${escapeHTML(post.title.rendered)}</h3><div class="text-gray-500 text-sm mb-4 line-clamp-3 flex-grow leading-relaxed" style="word-break: keep-all;">${escapeHTML(stripHTML(post.excerpt.rendered))}</div><div class="flex items-center text-xs text-gray-400 font-medium uppercase tracking-wider mt-auto pt-4 border-t border-gray-100"><i class="far fa-calendar-alt mr-2"></i> ${escapeHTML(date)}</div></article>`;
                }).join('');
            }).catch(e => renderMockJournal());
        }

        // Rest of functions...
        function loadInstagram() { db.collection('k_site_config').doc('instagram').onSnapshot(doc => { if(doc.exists) { const d = doc.data(); const images = [d.img1, d.img2, d.img3, d.img4].filter(url => url); const instaId = sanitizeHandle(d.insta_id || 'the_k_edit'); document.getElementById('insta-link').href = `https://instagram.com/${instaId}`; document.getElementById('insta-handle').innerText = `@${instaId}`; document.getElementById('insta-grid').innerHTML = images.map(img => `<div class="aspect-square bg-gray-100 relative group cursor-pointer overflow-hidden rounded-md w-full"><img src="${escapeHTML(safeUrl(img))}" class="img-fill transition duration-500 group-hover:scale-110" alt="Instagram image"><div class="absolute inset-0 bg-black/40 hidden group-hover:flex items-center justify-center text-white text-2xl"><i class="fas fa-heart"></i></div></div>`).join(''); } }); }
        function renderMockJournal() { document.getElementById('journal-grid').innerHTML = `<div class="col-span-3 text-center py-16 bg-gray-50 rounded-lg border border-dashed border-gray-300"><i class="fas fa-newspaper text-gray-300 text-4xl mb-4"></i><p class="text-gray-500 mb-2 font-medium">Journal posts are loading or not configured.</p><p class="text-xs text-gray-400">Please check Admin > Settings > WordPress Connection.</p></div>`; }
        function switchTab(id) { document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); document.querySelectorAll('button[id^="btn-"]').forEach(btn => btn.classList.remove('active-tab', 'text-black', 'border-black')); document.getElementById('btn-' + id).classList.add('active-tab', 'text-black', 'border-black'); document.getElementById('btn-' + id).classList.remove('text-gray-400'); }
        let isChatOpen = false;
        function toggleChat() { const win = document.getElementById('chat-window'); isChatOpen = !isChatOpen; if (isChatOpen) { win.classList.remove('hidden'); setTimeout(() => { win.classList.remove('scale-90', 'opacity-0'); win.classList.add('scale-100', 'opacity-100'); }, 10); document.getElementById('chat-input').focus(); } else { win.classList.remove('scale-100', 'opacity-100'); win.classList.add('scale-90', 'opacity-0'); setTimeout(() => win.classList.add('hidden'), 300); } }
        function sendPreset(msg) { document.getElementById('chat-input').value = msg; sendMessage(); }
        async function initChatContext() { db.collection('k_editions').get().then(snap => { snap.forEach(doc => siteContext.editions[doc.id] = doc.data()); }); const configDoc = await db.collection('k_site_config').doc('settings').get(); if(configDoc.exists && configDoc.data().wp_url) { const wpUrl = configDoc.data().wp_url.replace(/\/$/, ""); try { const res = await fetch(`${wpUrl}/wp-json/wp/v2/posts?per_page=5`, { credentials: 'omit' }); const posts = await res.json(); siteContext.posts = posts.map(p => ({ title: p.title.rendered, link: p.link })); } catch(e) {} } }
        async function sendMessage() { const input = document.getElementById('chat-input'); const msg = input.value.trim(); if (!msg) return; addMessage(msg, 'user'); input.value = ''; if (!geminiApiKey) { addMessage('AI chat is unavailable. Please contact us via WhatsApp.', 'bot'); return; } const typingId = addTypingIndicator(); const editionsContext = Object.entries(siteContext.editions).map(([key, val]) => `- ${val.title} (${val.subtitle}): $${val.price}. ${val.desc}`).join('\n'); const postsContext = siteContext.posts.map(p => `- Blog: ${p.title}`).join('\n'); const systemPrompt = `You are the AI Curator for 'THE K-EDIT'. Role: guide potential customers. Tone: Sophisticated, professional. Data: ${editionsContext} ${postsContext}. Rules: If user asks about booking or price negotiation, advise to contact manager via WhatsApp. Keep answers concise.`; try { const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiApiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: systemPrompt + "\n\nUser Question: " + msg }] }] }) }); const data = await response.json(); const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "Please contact us via WhatsApp."; removeMessage(typingId); addMessage(sanitizeHTML(marked.parse(reply)), 'bot', { asHTML: true }); } catch (e) { removeMessage(typingId); addMessage("System Error. Please try WhatsApp directly.", 'bot'); } }
        function addMessage(content, sender, opts = {}) { const container = document.getElementById('chat-messages'); const div = document.createElement('div'); div.className = `chat-message ${sender === 'user' ? 'chat-user' : 'chat-bot fade-in'}`; if (opts.asHTML) div.innerHTML = content; else div.textContent = content; container.appendChild(div); container.scrollTop = container.scrollHeight; return div.id = 'msg-' + Date.now(); }
        function addTypingIndicator() { const id = 'typing-' + Date.now(); const container = document.getElementById('chat-messages'); const div = document.createElement('div'); div.id = id; div.className = 'chat-message chat-bot flex gap-1 items-center py-4'; div.innerHTML = `<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>`; container.appendChild(div); container.scrollTop = container.scrollHeight; return id; }
        function removeMessage(id) { const el = document.getElementById(id); if (el) el.remove(); }
    </script>
</body>
</html>
